setup:
  addons:
    - plan: heroku-postgresql
      as: DATABASE
    - plan: heroku-redis:hobby-dev
      as: REDIS

build:
  docker:
    web: ./frontend/Dockerfile
    worker: ./backend/Dockerfile

release:
  command:
    - node backend/dist/db/migrate.js
  image: worker

run:
  frontend: nginx -g 'daemon off;'
  backend: node dist/index.js

env:
  NODE_ENV: production
  PORT: 8080
  DB_HOST: ${DATABASE_URL}
  REDIS_URL: ${REDIS_URL}

healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
  interval: 30s
  timeout: 10s
  retries: 3
